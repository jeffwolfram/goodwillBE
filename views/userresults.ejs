<%- include('layout') %>

<body class="usertotals">
    <%- include('header') %>

    <% // Group results by date %>
    <% let groupedResults = {}; %>

    <% results.forEach(result => { %>
        <% console.log(result) %>
        <% let dateKey = new Date(result.created_at).toDateString(); %>
        <% if (!groupedResults[dateKey]) { %>
            <% groupedResults[dateKey] = []; %>
        <% } %>
        <% groupedResults[dateKey].push(result); %>
    <% }); %>

    <% // Render a table for each date group %>
    <% Object.keys(groupedResults).forEach(date => { %>
        <h2><%= date %></h2>
        <table>
            <thead>
                <tr>
                    <th>User</th>
                    <th>Amount</th>
                    <th>Number</th>
                    <th>Item Average</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% let totalAmount = 0; %>
                <% let totalNumber = 0; %>

                <% groupedResults[date].forEach(result => { %>
                    <% let amount = parseFloat(result.amount); %>
                    <% let number = parseFloat(result.number); %>

                    <tr>
                        <td><%= result.name %></td>
                        <td><%= amount.toFixed(2) %></td>
                        <td><%= number %></td>
                        <td><%= (amount / number).toFixed(2) %></td>
                        <td>
                            <a href="/editnumbers/<%= result.id %>" class="edit-btn">Edit</a>
                        </td>
                    </tr>

                    <% totalAmount += amount; %>
                    <% totalNumber += number; %>
                <% }); %>

                <% let averageAmount = totalNumber ? totalAmount / totalNumber : 0; %>

                <tr>
                    <td><strong>Totals</strong></td>
                    <td><strong><%= totalAmount.toFixed(2) %></strong></td>
                    <td><strong><%= totalNumber %></strong></td>
                    <td><strong><%= averageAmount.toFixed(2) %></strong></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    <% }); %>
</body>
</html>
